# Биржа - курс по python от Точка

## Инструкция:
В корне лежит файл `.env.template` (пример).
- для запуска локально нужен файл `.env.local`


## Запуск локально:
Установка зависимостей:
```sh
poetry install
```

Запуск приложения:
```sh
uvicorn app.main:app --host localhost --port 8000  --reload
# Если не обновляются переменные окружения, запускаем командой:
uvicorn app.main:app --host localhost --port 8000  --reload  && source .env > /dev/null 2>&1
```

Запуск тестов:
```sh
pytest --cov=app --cov-report=term-missing --cov-report=xml
```

Запуск ruff:
```sh
ruff check .
```

Запуск mypy:
```sh
mypy .
```

## Запуск Docker контейнера:
```sh
docker build -t fastapi-app .
docker run -p 8000:8000 fastapi-app
```
Документация Swagger будет доступна по адресу localhost:8000/docs

---

## Работа с миграциями.
#### Создание файла миграций
- Чтобы автоматически создать файл миграции, выполните команду:
```sh
alembic revision --autogenerate -m "First migration"
# First migration - имя файла миграции
```
#### Применение миграций
- Выполнение всех неприменённых миграций запускается командой:
```sh
alembic upgrade head
```
#### Откат миграций
Если что-то пошло не так — можно отменить миграции: одну, несколько или вообще все.
```sh
alembic downgrade base  # Откатить все
alembic downgrade -1  # Откатить последнюю
```


## Структура проекта

```
app/                    # <-- Исходники приложения
├── api/                # <-- API приложения
│   ├── endpoints/      # <-- Эндпоинты
│   ├── utils/          # <-- Вспомогательные функции
│   ├── validators/     # <-- Валидаторы эндпоинтов
│   └── routers.py      # <-- Все роутеры приложени
├── core/               # <-- Ядро приложения
│   ├── docs/           # <-- Исправления для swagger
│   ├── middleware/     # <-- Middleware приложения
│   ├── modules/        # <-- Внешние / самописные модули приложения
│   ├── base.py         # <-- Импорты класса Base и всех моделей для Alembic
│   ├── config.py       # <-- Все конфиги и константы проекта
│   ├── db.py           # <-- Настройка соединения с БД
│   └── enums.py        # <-- Все emun перечисления приложения
├── crud/               # <-- Вся логика взаимодействия с БД
├── models/             # <-- Модели SQLAlchemy
├── schemas/            # <-- Схемы Pydantic
├── services/           # <-- Папка для бизнес-логики
├── tests/              # <-- Папка с тестами
└── main.py             # <-- Точка входа в приложение
static/                 # <-- Папка со статикой
```


<details>
<summary><h2>Разработка</h2></summary>

### Настройка pre-commit:

Pre-commit хуки позволяют проводить различные проверки до того как они были отправлены в общий репозиторий.

1. Установите pre-commit хуки, выполнив команду:
```sh
pre-commit install
```
2. Теперь, при каждом коммите, pre-commit будет автоматически запускать указанные хуки.

> pre-commit работает только с измененными файлами, если нужно применить ко всему проекту, выполните команду:
>```sh
>pre-commit run --all-files
>```

<details>
  <summary>Список примененных хуков:</summary>

`detect-private-key` - Обнаруживает наличие приватных ключей.

**Описание:** Если будет обнаружен приватный ключ, хук выдаст ошибку и процесс коммита будет остановлен. Вам потребуется удалить приватный ключ из кода и повторить попытку коммита.

`double-quote-string-fixer` - Заменяет строки в двойных кавычках на строки в одинарных кавычках.

**Описание:** Хук автоматически заменит двойные кавычки на одинарные и продолжит работу других хуков. Коммит не будет прерван.

`end-of-file-fixer` - Проверяет, что файл пуст или заканчивается одной пустой строкой.

**Описание:** Хук автоматически добавит пустую строку в конце файла (если она отсутствует) и продолжит работу других хуков. Коммит не будет прерван.

`mixed-line-ending` - Заменяет все окончания строк на LF.

**Описание:** Хук автоматически заменит все окончания строк на LF и продолжит работу других хуков. Коммит не будет прерван.

`no-commit-to-branch` - Запрещает коммиты в ветки main, master, dev.

**Описание:** Хук выдаст ошибку и процесс коммита будет остановлен, если попытка коммита происходит в указанные ветки. Вам потребуется сменить ветку и повторить попытку коммита.

`trailing-whitespace` - Обрезает завершающие пробелы в строках.

**Описание:** Хук автоматически удалит завершающие пробелы в строках и продолжит работу других хуков. Коммит не будет прерван.

`autoflake` - Удаляет неиспользуемые импорты.

**Описание:** Хук автоматически удалит неиспользуемые импорты и продолжит работу других хуков. Коммит не будет прерван.

`isort` - Форматирует импорты.

**Описание:** Хук автоматически отформатирует импорты и продолжит работу других хуков. Коммит не будет прерван.

`black` - Форматирует код.

**Описание:** Хук автоматически отформатирует код и продолжит работу других хуков. Коммит не будет прерван.

`flake8` - Проверяет длину строк, если есть строки больше 88 символов - укажет их.

**Описание:** Хук выдаст предупреждения или ошибки, если строки превышают допустимую длину в 88 символов. Процесс коммита будет остановлен, пока вы не исправите длинные строки.

`ruff` - Линтер.

**Описание:** Хук проведет проверку кода и выдаст ошибки или предупреждения, если будут обнаружены проблемы. Процесс коммита будет остановлен, пока вы не исправите все обнаруженные ошибки.

</details>
</details>
